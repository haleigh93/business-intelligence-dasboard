<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Debug Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #141b3d 100%);
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
            background: linear-gradient(135deg, #4a9eff 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #b8c5d6;
            margin-bottom: 30px;
        }

        .test-card {
            background: #1a2347;
            border: 1px solid #2d3b5f;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .test-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .test-number {
            background: #4a9eff;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .test-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status.loading {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .result-box {
            background: #0a0e27;
            border: 1px solid #2d3b5f;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #b8c5d6;
        }

        .fix-instructions {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .fix-instructions h3 {
            color: #ef4444;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .fix-instructions ol {
            margin-left: 20px;
            color: #b8c5d6;
        }

        .fix-instructions code {
            background: #1a2347;
            padding: 2px 6px;
            border-radius: 4px;
            color: #4a9eff;
        }

        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        button:hover {
            background: #6bb3ff;
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .summary {
            background: #1a2347;
            border: 2px solid #4a9eff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
        }

        .summary h2 {
            color: #4a9eff;
            margin-bottom: 15px;
        }

        .summary-status {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .summary-text {
            font-size: 1.1rem;
            color: #b8c5d6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Dashboard Debug Tool</h1>
        <p class="subtitle">Comprehensive diagnostics for your Business Intelligence Dashboard</p>

        <!-- Test 1: JavaScript Check -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-number">1</div>
                <div class="test-title">JavaScript Execution</div>
            </div>
            <div id="js-status" class="status success">‚úÖ JavaScript is working</div>
            <div class="result-box">
                <pre>JavaScript loaded and executing successfully!</pre>
            </div>
        </div>

        <!-- Test 2: API Stocks Endpoint -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-number">2</div>
                <div class="test-title">Stock API (/api/stocks)</div>
            </div>
            <div id="stocks-status" class="status loading">‚è≥ Testing...</div>
            <button id="retry-stocks" style="display: none;">üîÑ Retry</button>
            <div id="stocks-result" class="result-box">
                <pre>Running test...</pre>
            </div>
        </div>

        <!-- Test 3: API Earnings Endpoint -->
        <div class="test-card">
            <div class="test-header">
                <div class="test-number">3</div>
                <div class="test-title">Earnings API (/api/earnings)</div>
            </div>
            <div id="earnings-status" class="status loading">‚è≥ Testing...</div>
            <button id="retry-earnings" style="display: none;">üîÑ Retry</button>
            <div id="earnings-result" class="result-box">
                <pre>Running test...</pre>
            </div>
        </div>

        <!-- Summary -->
        <div id="summary" class="summary" style="display: none;">
            <div class="summary-status" id="summary-icon">üîÑ</div>
            <h2 id="summary-title">Analyzing...</h2>
            <div class="summary-text" id="summary-text">Tests in progress...</div>
        </div>
    </div>

    <script>
        console.log('üîç DEBUG TOOL: Starting diagnostics...');

        let stocksSuccess = false;
        let earningsSuccess = false;

        // Test Stocks API
        async function testStocks() {
            const statusDiv = document.getElementById('stocks-status');
            const resultDiv = document.getElementById('stocks-result');
            const retryBtn = document.getElementById('retry-stocks');

            try {
                console.log('üîç Testing /api/stocks...');
                statusDiv.className = 'status loading';
                statusDiv.textContent = '‚è≥ Testing...';

                const startTime = performance.now();
                const response = await fetch('/api/stocks');
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(0);

                console.log('üîç Stocks response:', response);

                let result = `HTTP Status: ${response.status} ${response.statusText}\n`;
                result += `Response Time: ${duration}ms\n`;
                result += `Content-Type: ${response.headers.get('content-type')}\n`;
                result += `\n--- Response Body ---\n\n`;

                const text = await response.text();
                console.log('üîç Stocks response body:', text);

                try {
                    const data = JSON.parse(text);
                    result += JSON.stringify(data, null, 2);

                    if (response.ok && data.success) {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = '‚úÖ Success';
                        stocksSuccess = true;

                        // Check for holidays
                        if (data.holidays && data.holidays.upcomingHolidays) {
                            result += `\n\n--- Holiday Analysis ---\n`;
                            result += `Upcoming Holidays: ${data.holidays.upcomingHolidays.length}\n`;
                            result += `Market Status: ${data.holidays.marketStatus}\n`;
                            if (data.holidays.upcomingHolidays.length > 0) {
                                result += `\nNext Holiday: ${data.holidays.upcomingHolidays[0].name} on ${data.holidays.upcomingHolidays[0].date}`;
                            }
                        }
                    } else {
                        throw new Error(data.message || 'API returned success=false');
                    }
                } catch (parseError) {
                    result += text;
                    throw new Error('Failed to parse JSON: ' + parseError.message);
                }

                resultDiv.innerHTML = `<pre>${result}</pre>`;
                retryBtn.style.display = 'none';

            } catch (error) {
                console.error('üîç Stocks error:', error);
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Error';
                stocksSuccess = false;

                let errorMsg = `Error: ${error.message}\n\n`;
                errorMsg += `This likely means:\n`;

                if (error.message.includes('API_KEY') || error.message.includes('Configuration error')) {
                    errorMsg += `‚Ä¢ The API_KEY environment variable is NOT set in Vercel\n`;
                    errorMsg += `‚Ä¢ This is the most common issue\n\n`;

                    resultDiv.innerHTML = `<pre>${errorMsg}</pre>`;
                    resultDiv.insertAdjacentHTML('beforeend', `
                        <div class="fix-instructions">
                            <h3>üîß How to Fix This</h3>
                            <ol>
                                <li>Go to <strong>Vercel Dashboard</strong> ‚Üí Your Project</li>
                                <li>Click <strong>Settings</strong> ‚Üí <strong>Environment Variables</strong></li>
                                <li>Add new variable: <code>API_KEY</code></li>
                                <li>Set value to: <code>3bfVQ5lCQSwpSW8uQ1WYgQ==tSIcWPx3Qatwfht1</code></li>
                                <li>Click <strong>Save</strong></li>
                                <li><strong>Redeploy</strong> your application (Deployments ‚Üí click ‚ãØ ‚Üí Redeploy)</li>
                            </ol>
                        </div>
                    `);
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += `‚Ä¢ You're testing locally (serverless functions only work on Vercel)\n`;
                    errorMsg += `‚Ä¢ OR there's a network issue\n`;
                    errorMsg += `‚Ä¢ OR the endpoint doesn't exist\n`;
                    resultDiv.innerHTML = `<pre>${errorMsg}</pre>`;
                } else {
                    errorMsg += error.stack || '';
                    resultDiv.innerHTML = `<pre>${errorMsg}</pre>`;
                }

                retryBtn.style.display = 'block';
            } finally {
                updateSummary();
            }
        }

        // Test Earnings API
        async function testEarnings() {
            const statusDiv = document.getElementById('earnings-status');
            const resultDiv = document.getElementById('earnings-result');
            const retryBtn = document.getElementById('retry-earnings');

            try {
                console.log('üîç Testing /api/earnings...');
                statusDiv.className = 'status loading';
                statusDiv.textContent = '‚è≥ Testing...';

                const testUrl = '/api/earnings?ticker=MSFT&year=2024&quarter=2';
                const startTime = performance.now();
                const response = await fetch(testUrl);
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(0);

                console.log('üîç Earnings response:', response);

                let result = `Test URL: ${testUrl}\n`;
                result += `HTTP Status: ${response.status} ${response.statusText}\n`;
                result += `Response Time: ${duration}ms\n`;
                result += `Content-Type: ${response.headers.get('content-type')}\n`;
                result += `\n--- Response Body ---\n\n`;

                const text = await response.text();
                console.log('üîç Earnings response body:', text.substring(0, 500));

                try {
                    const data = JSON.parse(text);

                    // Show summary instead of full data
                    if (data.success && data.data) {
                        result += `‚úÖ SUCCESS\n\n`;
                        result += `Company: ${data.data.companyName}\n`;
                        result += `Quarter: Q${data.data.quarter} ${data.data.year}\n`;
                        result += `Date: ${data.data.date}\n`;
                        result += `Ticker: ${data.data.ticker}\n`;
                        result += `Participants: ${data.data.participants?.length || 0}\n`;
                        result += `Transcript Entries: ${data.data.transcript_split?.length || 0}\n`;

                        statusDiv.className = 'status success';
                        statusDiv.textContent = '‚úÖ Success';
                        earningsSuccess = true;
                    } else {
                        result += JSON.stringify(data, null, 2);
                        throw new Error(data.message || 'API returned success=false');
                    }
                } catch (parseError) {
                    result += text.substring(0, 1000);
                    throw new Error('Failed to parse JSON: ' + parseError.message);
                }

                resultDiv.innerHTML = `<pre>${result}</pre>`;
                retryBtn.style.display = 'none';

            } catch (error) {
                console.error('üîç Earnings error:', error);
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Error';
                earningsSuccess = false;

                let errorMsg = `Error: ${error.message}\n\n`;

                if (error.message.includes('API_KEY') || error.message.includes('Configuration error')) {
                    errorMsg += `The API_KEY environment variable is NOT configured.\n`;
                    errorMsg += `See the fix instructions above (Test 2).\n`;
                } else if (error.message.includes('404') || error.message.includes('Not found')) {
                    errorMsg += `The requested earnings transcript may not be available yet.\n`;
                    errorMsg += `This is normal for very recent quarters.\n`;
                } else {
                    errorMsg += error.stack || '';
                }

                resultDiv.innerHTML = `<pre>${errorMsg}</pre>`;
                retryBtn.style.display = 'block';
            } finally {
                updateSummary();
            }
        }

        // Update summary
        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            const iconDiv = document.getElementById('summary-icon');
            const titleDiv = document.getElementById('summary-title');
            const textDiv = document.getElementById('summary-text');

            summaryDiv.style.display = 'block';

            if (stocksSuccess && earningsSuccess) {
                iconDiv.textContent = '‚úÖ';
                titleDiv.textContent = 'All Systems Operational';
                titleDiv.style.color = '#10b981';
                textDiv.innerHTML = 'Both API endpoints are working correctly!<br>Your dashboard should be fully functional.';
            } else if (stocksSuccess || earningsSuccess) {
                iconDiv.textContent = '‚ö†Ô∏è';
                titleDiv.textContent = 'Partial Success';
                titleDiv.style.color = '#fbbf24';
                textDiv.innerHTML = 'Some endpoints are working, but others have issues.<br>Check the error messages above.';
            } else {
                iconDiv.textContent = '‚ùå';
                titleDiv.textContent = 'Configuration Required';
                titleDiv.style.color = '#ef4444';
                textDiv.innerHTML = 'API endpoints are not working.<br><strong>Most likely cause: API_KEY environment variable not set in Vercel.</strong><br>Follow the fix instructions above.';
            }
        }

        // Retry buttons
        document.getElementById('retry-stocks').addEventListener('click', testStocks);
        document.getElementById('retry-earnings').addEventListener('click', testEarnings);

        // Run tests
        console.log('üîç Running all diagnostic tests...');
        testStocks();
        testEarnings();
    </script>
</body>
</html>
